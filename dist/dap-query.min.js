!function(){"use strict";!function(e){var n="undefined"!=typeof window?window:global,r=Object.prototype.hasOwnProperty.call(n,e),t=n[e],a=n[e]={};"undefined"!=typeof module&&module.exports&&(module.exports=a),a.noConflict=function(){if(n[e]===a&&(n[e]=r?t:void 0,!r))try{delete n[e]}catch(i){}return a};var i=function(e){Object.keys(e.variables).forEach(function(n){var r=e.variables[n];if(r.units&&!(r.units.indexOf("days since ")<0&&r.units.indexOf("seconds since ")<0)){r.scale=r.units.split(" ")[0];var t=r.units.substr(r.scale.length+7),a=t.split(/[ \-\:]/);r.epoch=new Date(Date.UTC(+a[0],+a[1]-1,+a[2],a[3]||null,a[4]||null,a[5]||null)),r.epoch.setUTCFullYear(+a[0])}})};a.dasToJSON=function(e){e="{\n"+e+"\n}";var n,r=e.split("\n"),t=[];r.forEach(function(e){var r=(e.replace(/\\"/g,"").match(/"/g)||[]).length;n?r%2?(t.push(n+e),n=void 0):n+=e:r%2?n=e:(r>2&&(e=e.replace(/"/,'["').replace(/"([^"]*)$/,'"]$1')),t.push(e))}),n&&t.push(n),t=t.map(Function.prototype.call,String.prototype.trim);var a=function(e){if(e===t.length-1)return!0;for(var n=e+1;n<t.length;n++){if("}"===t[n])return!0;if(t[n].length)return!1}return!0};t=t.map(function(e,n){if(!e.length)return"";if("{"===e)return"{";if("}"===e[0])return a(n)?"}":"},";var r;if("{"===e[e.length-1])return r=e.split(" "),'"'+r[0]+'":{';r=e.split(" ");var t=r[0],i=r[1],l=t.length+i.length+2,s=e.substr(l,e.length-l-1);"String"!==t&&s.indexOf(",")>=0&&(s="["+s+"]"),"NaN"===s&&(s="null");var u='"'+i+'":'+s;return a(n)||(u+=","),u});var i=t.join("\n");return i},a.parseDAS=function(e){var n={variables:{}},r=a.dasToJSON(e),t=JSON.parse(r).Attributes;for(var l in t)"NC_GLOBAL"===l?n.attr=t[l]:n.variables[l]=t[l];return i(n),n};var l=function(e,n){for(var r in e)n[r]=e[r];return n},s=function(e){for(var n={},r=e.getElementsByTagName("Attribute"),t=0;t<r.length;t++){var a=r[t],i=a.getElementsByTagName("value")[0].textContent;n[a.getAttribute("name")]=i}return n},u=function(e){var n={};n.dimensions=[],n=l(s(e),n);for(var r=0;r<e.childNodes.length;r++){var t=e.childNodes[r];"Attribute"!==t.nodeName&&"#text"!==t.nodeName&&("dimension"===t.nodeName?n.dimensions.push({name:t.getAttribute("name"),size:t.getAttribute("size")}):n.dType=t.nodeName)}return n};a.parseDDX=function(e){var n=new DOMParser;e=e.replace("<Datasetname","<Dataset name");var r=n.parseFromString(e,"text/xml");r=r.documentElement;var t,a,o,c={variables:{}},f=r.getElementsByTagName("Grid");for(t=0;t<f.length;t++){var v=f[t];a=v.getAttribute("name"),o={},o=l(s(v),o);var p=v.getElementsByTagName("Array")[0];o=l(u(p),o),c.variables[a]=o}var m=r.getElementsByTagName("Array");for(t=0;t<m.length;t++){var d=m[t];"Grid"!==d.parentNode.nodeName&&(a=d.getAttribute("name"),c.variables[a]=u(d))}return i(c),c};var o=function(e,n){if(1===n.length)return"["+e[0]+"]";if(2===n.length)return"["+e.map(function(e){var n=e.split(",");return"["===n[0][0]&&n.shift(),"["+n.join(",")+"]"}).join(",\n")+"]\n";for(var r=[],t=0;t<n[0];t++){var a=o(e.slice(t,t+n[1]),n.slice(1));t<n[0]-1&&(a+=","),a+="\n",r.push(a)}return"["+r.join("")+"]"};return a.parseDDS=function(e){var n=e.split("\n").map(function(e){return e.trim()}),r={variables:{}},t=null,a=!1,i=function(e){var n=e.split(/[ \[=\];]+/),t=n[1];r.variables[t]={dimensions:[]};for(var a=2;a<n.length-1;a+=2)r.variables[t].dimensions.push({name:n[a],size:+n[a+1]});return t};return n.slice(1).forEach(function(e){return e.endsWith("{")?(a=!0,void 0):e.startsWith("}")?(t=null,a=!1,void 0):null===t&&e.endsWith(";")?(t=i(e),a||(t=null),void 0):(e.endsWith(":"),void 0)}),r},a.dataToJSON=function(e){var n=e.split(/\n-+\w*\n/),r=n[n.length-1],t=r.trim().split(/\n+(?=[a-zA-Z])/);return t=t.map(function(e){var n=e.split(/\n+/),r=n.shift(),t=r.split("["),a=t.shift().split(".").pop().trim().replace(",","");t=t.map(function(e){return+e.slice(0,e.length-1)});var i=o(n,t).replace(/NaN/g,"null");return'"'+a+'":'+i}),"{"+t.join(",\n")+"}"},a.parseData=function(e,n,r){var t=JSON.parse(a.dataToJSON(e));if(n&&Object.keys(t).forEach(function(e){if(n.variables[e]){var r=n.variables[e];if(r.epoch){var a=r.epoch;t[e]=t[e].map(function(e){if("days"===r.scale){var n=new Date(a),t=864e5;return n.setTime(n.getTime()+e*t),n}return"seconds"===r.scale?new Date(a.getTime()+1e3*e):null})}}}),n)for(var i in t)void 0!==r&&void 0!==r[i]?a.replaceValues(t[i],r[i],0/0):n.variables[i]&&n.variables[i]._FillValue&&a.replaceValues(t[i],+n.variables[i]._FillValue,0/0),n.variables[i]&&n.variables[i].scale_factor&&a.scaleValues(t[i],+n.variables[i].scale_factor);return t},a.replaceValues=function(e,n,r){for(var t in e)null===e[t]&&(e[t]=0/0),e[t].length?a.replaceValues(e[t],n,r):e[t]===n&&(e[t]=r)},a.scaleValues=function(e,n){for(var r in e)null!==e[r]&&(e[r].length?a.scaleValues(e[r],n):e[r]*=n)},a.simplifyVariable=function(e){return"[object Array]"===Object.prototype.toString.call(e)?1===e.length?a.simplifyVariable(e[0]):e.map(function(e){return a.simplifyVariable(e)}):e},a.simplify=function(e){var n={};for(var r in e)n[r]=a.simplifyVariable(e[r]);return n},a.sliceToQuery=function(e){var n=e instanceof Array?e:[e];return 1===n.length&&(n=[n[0],n[0]]),2===n.length&&(n=[n[0],1,n[1]]),"["+n.join(":")+"]"},a.makeQuery=function(e,n,r){r=r||{};var t=e.variables[n];return t.dimensions.map(function(e){var n=e.name,t=r[n];return void 0===t&&(t=[0,+e.size-1]),a.sliceToQuery(t)}).join("")},a}("dap")}();